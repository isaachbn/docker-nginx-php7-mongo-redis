machine:
  services:
    - docker
  environment:
     TAG: $CIRCLE_BRANCH-$CIRCLE_SHA1
     DOCKER_REGISTRY: isaachbn/docker-nginx-php7-mongo-redis
     BUILD: ${CIRCLE_BUILD_NUM}
     CONTAINER1: $(tr [A-Z] [a-z] <<< ${CIRCLE_PROJECT_USERNAME:0:8})/$(tr [A-Z] [a-z] <<< ${CIRCLE_PROJECT_REPONAME:0:15}| tr -d '_-')
     DOCKER_IMAGE: MY_ORGANIZATION/MY_IMAGE_NAME:$CIRCLE_BRANCH-$CIRCLE_SHA1

dependencies:
  override:
    - sudo docker info
    - docker build -t isaachbn/docker-nginx-php7-mongo-redis .

test:
  override:
    - sudo docker-compose run -d web
    - sudo docker-compose stop

deployment:
  staging:
    branch: [master, /automatic-.*/]
    commands:
      - sudo docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
      - sudo docker push ${DOCKER_REGISTRY}/${CONTAINER1}:build${BUILD}
      - sudo docker push ${DOCKER_REGISTRY}/${CONTAINER1}:latest